<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Etsy → Luca e-Arşiv · Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .sidebar-link{display:flex;align-items:center;gap:.75rem;padding:.625rem .75rem;border-radius:.75rem;color:#374151}
    .sidebar-link:hover{background:#f3f4f6}
    .sidebar-link.active{background:#111827;color:#fff}
    .tw-sticky { position: sticky; top: 0; background: white; z-index: 10; }
    .card { border-radius:1rem; background:#fff; border:1px solid #e5e7eb; }
    .input { width:100%; border:1px solid #e5e7eb; border-radius:.75rem; padding:.5rem .75rem }
    .label { font-size:.85rem; color:#6b7280 }
    .section-title { font-size:.9rem; font-weight:600; color:#111827 }
    .hint { font-size:.75rem; color:#6b7280 }
    .toggle { position:relative; width:3rem; height:1.6rem; background:#e5e7eb; border-radius:9999px; transition:.15s; }
    .toggle:has(input:checked) { background:#111827; }
    .toggle span { position:absolute; top:.15rem; left:.2rem; width:1.3rem; height:1.3rem; background:#fff; border-radius:9999px; transition:.15s; }
    .toggle:has(input:checked) span { left:1.5rem; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="min-h-screen grid grid-cols-12">
    <!-- Sidebar -->
    <aside class="col-span-12 md:col-span-2 lg:col-span-2 xl:col-span-2 bg-white border-r">
      <div class="p-4 flex items-center gap-2">
        <div class="w-9 h-9 rounded-xl bg-black text-white grid place-items-center font-semibold">EL</div>
        <div class="text-sm">
          <div class="font-semibold">Etsy → Luca</div>
          <div class="text-xs text-gray-500">e-Arşiv panel</div>
        </div>
      </div>
      <nav class="px-3 space-y-1">
        <a class="sidebar-link" href="/">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-5m0 0h-5m5 0h-3"/></svg>
          Dashboard
        </a>
        <a class="sidebar-link active" href="/settings">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.983 2a1 1 0 0 1 .993.883l.007.117v1.2a8.01 8.01 0 0 1 1.88.776l.85-.85a1 1 0 0 1 1.414 0l1.697 1.697a1 1 0 0 1 0 1.414l-.85.85A8.01 8.01 0 0 1 19.8 11h1.2a1 1 0 0 1 .117 1.993L21 13h-1.2a8.01 8.01 0 0 1-.776 1.88l.85.85a1 1 0 0 1 0 1.414l-1.697 1.697a1 1 0 0 1-1.414 0l-.85-.85A8.01 8.01 0 0 1 13 19.8V21a1 1 0 0 1-1.993.117L11 21v-1.2a8.01 8.01 0 0 1-1.88-.776l-.85.85a1 1 0 0 1-1.414 0L4.16 18.177a1 1 0 0 1 0-1.414l.85-.85A8.01 8.01 0 0 1 4.2 13H3a1 1 0 1 1 0-2h1.2a8.01 8.01 0 0 1 .776-1.88l-.85-.85a1 1 0 0 1 0-1.414L5.823 3.16a1 1 0 0 1 1.414 0l.85.85A8.01 8.01 0 0 1 11 4.2V3a1 1 0 0 1 .883-.993L12 2zM12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/></svg>
          Settings
        </a>
        <a class="sidebar-link" href="/logout">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6A2.25 2.25 0 0 0 5.25 5.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15M12 9l3 3m0 0-3 3m3-3H8.25"/></svg>
          Logout
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <section class="col-span-12 md:col-span-10 xl:col-span-10">
      <!-- Header -->
      <header class="tw-sticky border-b">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center gap-3">
          <div>
            <div class="text-2xl font-semibold">Settings</div>
            <div class="text-sm text-gray-600">Connect Etsy & Luca and tune behavior</div>
          </div>
          <div class="ml-auto flex items-center gap-2">
            <form action="/sync-now" method="post">
              <button class="inline-flex items-center gap-2 rounded-xl bg-black text-white px-4 py-2 hover:bg-gray-800">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2a1 1 0 1 1 2 0v2.05A8.002 8.002 0 0 1 20 12h-2a6 6 0 1 0-6 6v-3l5 4-5 4v-3a8 8 0 1 1-1-15.95V2z"/></svg>
                Sync now
              </button>
            </form>
            <a href="/" class="inline-flex items-center gap-2 rounded-xl border px-4 py-2 hover:bg-gray-50">Back to dashboard</a>
          </div>
        </div>
      </header>

      <main class="max-w-7xl mx-auto px-6 py-6">

        <!-- Flash banners -->
        {% if msg %}
          <div class="mb-4 card border-emerald-200 bg-emerald-50 text-emerald-800 px-4 py-3">{{ msg }}</div>
        {% endif %}
        {% if err %}
          <div class="mb-4 card border-rose-200 bg-rose-50 text-rose-800 px-4 py-3">{{ err }}</div>
        {% endif %}

        <!-- Status cards -->
        <div class="grid md:grid-cols-3 gap-4 mb-6">
          <div class="card p-4">
            <div class="text-sm text-gray-500">Auto-invoice</div>
            {% set auto = st.get('auto_invoice','false') %}
            <div class="mt-1 text-xl font-semibold">{{ 'ON' if auto == 'true' else 'OFF' }}</div>
            <div class="mt-2 hint">When ON, new paid orders will be invoiced & sent automatically.</div>
          </div>
          <div class="card p-4">
            <div class="text-sm text-gray-500">Poll interval (minutes)</div>
            <div class="mt-1 text-xl font-semibold">{{ st.get('poll_minutes') }}</div>
            <div class="mt-2 hint">The background sync uses this interval.</div>
          </div>
          <div class="card p-4">
            <div class="text-sm text-gray-500">Last cursor (epoch)</div>
            <div class="mt-1 text-xl font-semibold">{{ st.get('last_sync_epoch') or '0' }}</div>
            <div class="mt-2 hint">Orders updated after this timestamp are fetched.</div>
          </div>
        </div>

        <!-- MAIN FORM (no nested forms inside) -->
        <form action="/settings" method="post" class="grid md:grid-cols-12 gap-4">
          <!-- Etsy -->
          <div class="md:col-span-12 section-title">Etsy</div>
          <div class="md:col-span-6 card p-4 space-y-3">
            <div>
              <label class="label">Client ID (App Key)</label>
              <input class="input" name="etsy_client_id" value="{{ st.get('etsy_client_id','') }}" placeholder="your_etsy_app_key" autocomplete="off">
              <div class="hint mt-1">Etsy Developers → Your App → Keystring.</div>
            </div>
            <div>
              <label class="label">Refresh Token</label>
              <div class="flex gap-2">
                <input class="input flex-1" type="password" id="etsy_refresh_token" name="etsy_refresh_token" value="{{ st.get('etsy_refresh_token','') }}" placeholder="Paste refresh token">
                <button type="button" class="px-3 rounded-lg border" onclick="toggle('etsy_refresh_token')">Show</button>
              </div>
            </div>
            <div>
              <label class="label">Shop ID</label>
              <input class="input" name="etsy_shop_id" value="{{ st.get('etsy_shop_id','') }}" placeholder="Numeric shop id">
            </div>
          </div>

          <!-- Luca -->
          <div class="md:col-span-12 section-title">Luca (TÜRMOB e-Belge)</div>
          <div class="md:col-span-6 card p-4 space-y-3">
            <div>
              <label class="label">Identity (TCKN/VKN/User)</label>
              <input class="input" name="luca_identity" value="{{ st.get('luca_identity','') }}" placeholder="12345678901">
            </div>
            <div>
              <label class="label">Password</label>
              <div class="flex gap-2">
                <input class="input flex-1" type="password" id="luca_password" name="luca_password" value="{{ st.get('luca_password','') }}" placeholder="Luca password">
                <button type="button" class="px-3 rounded-lg border" onclick="toggle('luca_password')">Show</button>
              </div>
            </div>
            <div>
              <label class="label">Company ID</label>
              <input class="input" name="luca_company_id" value="{{ st.get('luca_company_id','') }}" placeholder="Numeric company id">
            </div>
            <div>
              <label class="label">Base URL</label>
              <input class="input" name="luca_base" value="{{ st.get('luca_base','https://einvoiceapiturmob.luca.com.tr') }}">
              <div class="hint mt-1">Keep default unless your tenant uses a different base.</div>
            </div>
          </div>

          <!-- Behavior -->
          <div class="md:col-span-12 section-title">Behavior</div>
          <div class="md:col-span-6 card p-4 space-y-3">
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="label">Poll interval (minutes)</label>
                <input class="input" type="number" min="1" name="poll_minutes" value="{{ st.get('poll_minutes','5') }}">
              </div>
              <div>
                <label class="label">Orders lookback (days)</label>
                <input class="input" type="number" min="1" name="lookback_days" value="{{ st.get('lookback_days','60') }}">
              </div>
              <div>
                <label class="label">Default KDV rate (%)</label>
                <input class="input" type="number" min="0" step="0.01" name="default_kdv_rate" value="{{ st.get('default_kdv_rate','0') }}">
              </div>
              <div>
                <label class="label">Currency fallback</label>
                <input class="input" name="currency_fallback" value="{{ st.get('currency_fallback','TRY') }}" placeholder="TRY">
              </div>
            </div>

            <div class="flex items-center gap-3 pt-2">
              <label class="label">Auto-create & send invoices</label>
              <label class="toggle">
                <input type="checkbox" name="auto_invoice" {{ 'checked' if auto == 'true' else '' }} class="sr-only">
                <span></span>
              </label>
            </div>
          </div>

          <!-- Save -->
          <div class="md:col-span-12 flex flex-wrap gap-2 pt-2">
            <button class="rounded-xl bg-black text-white px-5 py-2 hover:bg-gray-800">Save settings</button>
            <a href="/" class="rounded-xl border px-4 py-2 hover:bg-gray-50">Cancel</a>
          </div>
        </form>

        <!-- Separate small forms for tests (avoid nesting) -->
        <div class="md:col-span-12 flex flex-wrap gap-2 pt-4">
          <form action="/settings/test/etsy" method="post">
            <button class="rounded-xl border px-4 py-2 hover:bg-gray-50">Test Etsy</button>
          </form>
          <form action="/settings/test/luca" method="post">
            <button class="rounded-xl border px-4 py-2 hover:bg-gray-50">Test Luca</button>
          </form>
        </div>

        <div class="mt-6 hint">
          Tip: keep <b>ADMIN_PASSWORD</b> and <b>APP_SECRET</b> in Portainer env vars (not in Git). Settings persist in
          the volume <code>etsy_luca_data</code>.
        </div>
      </main>
    </section>
  </div>

  <script>
    function toggle(id){
      const el = document.getElementById(id);
      if(!el) return;
      el.type = el.type === 'password' ? 'text' : 'password';
    }
  </script>
</body>
</html>
